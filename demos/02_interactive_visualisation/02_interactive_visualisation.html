<!DOCTYPE html>
<html>
<head>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.0/full/pyodide.js"></script>
  <script src="../pyjamas/pjs.js"></script>
</head>

<body style="background-color: black; color: white; font-family: monospace;">
<h1>Interactive Python</h1>
<p id="output"></p>
<div id="status"" style="white-space: pre-wrap;"> </div><br>
<svg id="figure" width="800" height="800" style="border: 1px solid black; background-color: white;"></svg>

<script>

// convert simulation coordinates to UI coordinates 
// sorry Aurelien, I know you're going to hate this.
const FACTOR = 50;
const CENTER = 400;
function pyToUI(x) {
    return FACTOR * x + CENTER;
}

// get user state
async function getUserState() {
    return ;
}

function update_simulation() {
    // update physics simulation
    pjs.run("o = step(agents, o)").then(() => {
            // update target positions
            const targetPositions = pjs.get("o").toJs().get('ui').get('x');
            for (let i = 0; i < targetPositions.length; i++) {
                agent = document.getElementById("ui_"+i);
                agent.setAttribute("cy", Math.trunc( pyToUI(targetPositions[i] )));
            }
            
            pjs.run("o['user'].item()").then((userState) => {
                const userY = pyToUI(userState);
                line = document.getElementById("user");
                line.setAttribute("y1", userY);
                line.setAttribute("y2", userY);
            });
            
        })
}

async function main_spring() {
    // set "status" as the standard output DOM element.
    await pjs.init("status", {flush:true}); 
    // run script
	await pjs.fetch_and_run('script.py');
    
    
    
    // get number of targets
    const numTargets = await pjs.get('o').toJs().get('ui').get('x').length;
    
	// display instructions
	//pjs.stdout.print("Can you stabilise invidiual balls via vertical mouse movements on the canvas?", {prefix: ""});
    
	// create user representations
    var svg = document.getElementById("figure");
    const width = svg.width.baseVal.value; //svg.getBBox().width;
	var line = document.createElementNS("http://www.w3.org/2000/svg", "line");
	line.setAttribute("id", "user");
	line.setAttribute("x1", 0);
	line.setAttribute("x2", width);
	
    var userState = await getUserState();
    const userY = Math.trunc(pyToUI(userState));
	line.setAttribute("y1", userY);
	line.setAttribute("y2", userY);
	line.setAttribute("stroke", "gray");
	svg.appendChild(line);
    
    // create object representations
    const distance = Math.trunc( width / (numTargets + 1) );
    for (var i = 0; i < numTargets; i++) {
        var circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute('cx', (i+1) * distance);
        circle.setAttribute('cy', 0);
        circle.setAttribute('r', 10);
        circle.setAttribute('id', "ui_"+i);
        // random color
        circle.setAttribute('style', 'fill: #'+Math.floor(Math.random()*16777215).toString(16) );
        svg.appendChild(circle);
    }
    
    // start update loop
    setInterval(update_simulation, 20);
}

main_spring();

</script>

</body>
</html>